# TT 共享库项目说明

## 项目概述

已成功创建 TT（Telegram Tools）共享库，这是一个可通过 `pip install git+ssh://...` 安装的 Python 包，专为基于 Telethon 的 Telegram 自动化项目设计。

## 目录结构

```
ttlib/
├── tt/                          # 核心库代码
│   ├── __init__.py             # 包初始化，导出主要类和函数
│   ├── db.py                   # 数据库操作类
│   ├── client.py               # Telegram 客户端封装
│   ├── log.py                  # 日志管理（含 Telethon 日志配置）
│   ├── config.py               # 配置管理（YAML + 命令行参数）
│   └── app.py                  # 应用框架（健壮性代码）
│
├── README.md                    # 完整的使用文档和 API 文档
├── GETTING_STARTED.md          # 快速开始指南
├── MIGRATION_GUIDE.md          # 从旧项目迁移指南
├── CHANGELOG.md                # 版本更新日志
│
├── example.py                   # 完整的使用示例
├── test_install.py             # 安装测试脚本
├── config.example.yaml         # 配置文件示例
│
├── setup.py                    # 传统安装配置
├── pyproject.toml              # 现代 Python 项目配置
├── requirements.txt            # 依赖列表
├── MANIFEST.in                 # 打包文件清单
├── LICENSE                     # MIT 许可证
└── .gitignore                  # Git 忽略配置
```

## 核心功能

### 1. 数据库操作 (DB)
- ✅ 基于 PyMySQL 的数据库封装
- ✅ 支持上下文管理器（`with` 语句）
- ✅ 自动连接管理，无需手动 `conn()` 和 `close()`
- ✅ 连接状态检查和自动重连
- ✅ 提供 query, insert, update, delete 等方法

### 2. Telegram 客户端 (TGClient)
- ✅ 基于 Telethon 的客户端封装
- ✅ 简化登录流程（验证码登录、两步验证）
- ✅ 支持代理配置
- ✅ 提供常用操作方法（发送消息、获取用户信息等）

### 3. 日志管理 (Logger)
- ✅ 使用北京时间（固定）
- ✅ 封装常用日志方法（info, err, warn, debug, exception）
- ✅ **已解决 Telethon 日志时间显示问题**
- ✅ 自动配置 Telethon 库的日志格式

### 4. 配置管理 (Config)
- ✅ 支持 YAML 配置文件
- ✅ 支持 `--config` 命令行参数
- ✅ 点号分隔的嵌套键访问
- ✅ 提供便捷属性访问（proxy, db_name, api_id 等）

### 5. 应用框架 (TelegramApp)
- ✅ 应用生命周期管理
- ✅ 启动和关闭处理器
- ✅ 自动信号处理（SIGINT, SIGTERM）
- ✅ 优雅关闭和任务取消
- ✅ 全局异常处理

### 6. 任务管理器 (TaskManager)
- ✅ 管理多个长期运行的任务
- ✅ 任务添加、移除、取消

## 使用步骤

### 第一步：发布到 GitHub

```bash
cd /Users/numbx/dev/pc28sender/client/ttlib

# 初始化 Git 仓库
git init
git add .
git commit -m "Initial commit: TT library v0.1.0"

# 在 GitHub 创建仓库后
git remote add origin git@github.com:你的用户名/tt.git
git branch -M main
git push -u origin main

# 打标签
git tag -a v0.1.0 -m "Version 0.1.0"
git push origin --tags
```

### 第二步：在新项目中安装

```bash
# 方式 1: SSH 安装（推荐）
pip install git+ssh://git@github.com/你的用户名/tt.git

# 方式 2: HTTPS 安装
pip install git+https://github.com/你的用户名/tt.git

# 方式 3: 本地开发安装
cd ttlib
pip install -e .
```

### 第三步：测试安装

```bash
cd ttlib
python test_install.py
```

应该看到所有测试通过的消息。

### 第四步：创建配置文件

在你的项目中创建 `config.yaml`：

```yaml
proxy:
  enabled: true
  type: http
  host: 127.0.0.1
  port: 7890

database:
  name: mydb
  password: "your_password"

telegram:
  api_id: 12345678
  api_hash: "your_api_hash"

bot:
  id: 123456789
  username: "your_bot"
  token: "your_bot_token"
```

### 第五步：编写代码

```python
from tt import TelegramApp, info

app = TelegramApp(config_path='config.yaml')

@app.on_startup
async def startup():
    info("应用启动")
    # 你的初始化逻辑

@app.on_shutdown
async def shutdown():
    info("应用关闭")

if __name__ == '__main__':
    app.run()
```

## 配置说明

### 简化的配置格式

根据你的要求，配置已经简化：

1. **Proxy**: 布尔类型 `enabled`，如果启用则使用固定配置
2. **Database**: 只需要 `name` 和 `password`（其他可选）

```yaml
proxy:
  enabled: true          # 只需要这个布尔值
  # 可选：type, host, port（默认值已设置）

database:
  name: mydb            # 必需
  password: "123456"    # 必需
  # 可选：host, port, user（有默认值）
```

## 迁移现有项目

详细的迁移指南请查看 `MIGRATION_GUIDE.md`。

简要步骤：
1. 安装 TT 库
2. 创建 `config.yaml` 替代 `conf.py`
3. 修改导入语句
4. 使用 `TelegramApp` 简化主程序
5. 删除旧的 `tt/` 目录

## 主要改进

### 对比原项目

**之前的问题：**
- ❌ `DB.__exit__` 方法签名错误
- ❌ 每次数据库操作都要 `conn()` 和 `close()`
- ❌ 配置是 Python 代码，不安全且不易修改
- ❌ Telethon 日志不显示时间
- ❌ 主程序中大量样板代码（信号处理、异常处理）

**现在的解决方案：**
- ✅ 修复了 `__exit__` 方法
- ✅ 使用 `with` 语句自动管理连接
- ✅ YAML 配置，安全且易于修改
- ✅ Telethon 日志自动配置为北京时间
- ✅ `TelegramApp` 框架处理所有样板代码

## 文档清单

| 文件 | 说明 |
|------|------|
| README.md | 完整的使用文档和 API 参考 |
| GETTING_STARTED.md | 快速开始指南，包含发布和安装步骤 |
| MIGRATION_GUIDE.md | 从旧项目迁移的详细指南 |
| CHANGELOG.md | 版本更新日志 |
| example.py | 完整的使用示例（3 种方式） |
| config.example.yaml | 配置文件示例 |
| test_install.py | 安装测试脚本 |

## 下一步

1. **修改 GitHub 仓库地址**
   - 在以下文件中将 `yourusername` 替换为你的 GitHub 用户名：
     - setup.py
     - README.md
     - GETTING_STARTED.md
     - MIGRATION_GUIDE.md

2. **（可选）修改作者信息**
   - setup.py 中的 `author` 和 `author_email`
   - pyproject.toml 中的 `authors`

3. **发布到 GitHub**
   - 按照上面的步骤发布

4. **在新项目中使用**
   - 按照 GETTING_STARTED.md 的指引使用

5. **（可选）迁移现有项目**
   - 按照 MIGRATION_GUIDE.md 迁移你的 pc28sender 项目

## 技术细节

### 依赖项
- telethon >= 1.28.0
- PyMySQL >= 1.0.0
- pytz >= 2023.3
- PyYAML >= 6.0
- PySocks >= 1.7.1

### 兼容性
- Python 3.7+
- 支持 asyncio
- 跨平台（Windows, Linux, macOS）

### 代码风格
- 保持了你原有的代码风格
- 添加了详细的中文注释
- 提供了类型提示的基础

## 常见问题

### Q: 如何更新库？
```bash
pip install --upgrade git+ssh://git@github.com/你的用户名/tt.git
```

### Q: 如何本地开发？
```bash
cd ttlib
pip install -e .  # 修改代码会立即生效
```

### Q: 配置文件必须叫 config.yaml 吗？
不，你可以使用任意名称，通过 `--config` 参数指定：
```bash
python main.py --config my_config.yaml
```

### Q: 可以不使用应用框架吗？
可以，所有组件都可以独立使用：
```python
from tt import DB, Config, TGClient, info
# 直接使用各个组件
```

## 支持

如有问题或建议：
- 查看 README.md 获取详细文档
- 查看 example.py 获取示例代码
- 提交 GitHub Issue

## 许可证

MIT License - 详见 LICENSE 文件

---

**恭喜！TT 共享库已经创建完成，可以开始使用了！** 🎉

